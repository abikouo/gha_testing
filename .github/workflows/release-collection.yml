---
name: Release collection

concurrency:
  group: '${{ github.workflow }} @ ${{ github.sha }}'
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      repository:
        description: "The repository name. e.g: 'ansible-collections/amazon.cloud'"
        required: true
      version:
        description: "The version to release. e.g: '5.0.1'"
        required: true
      token:
        description: "The Github token to use"
        required: true
      

jobs:
  create:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          repository: ${{ inputs.repository }}
          fetch-depth: "0"
          token: "${{ inputs.token }}"

      - name: Validate version format
        run: |-
          python -c "import os, re, sys;
          version=os.environ.get('RELEASE_VERSION');
          print('version <%s> is matching expecting format' % version) if re.match(r'^[0-9]+\.[0-9]+\.[0-9]+$', version) else sys.exit(1)"
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.version }}

      - name: Define branches
        run: |
          echo "STABLE_BRANCH='stable-$(echo $RELEASE_VERSION | cut -d '.' -f1)'" >> $GITHUB_ENV
          echo "DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')" >> $GITHUB_ENV
          echo "RELEASE_BRANCH='release-${RELEASE_VERSION}'" >> $GITHUB_ENV
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.version }}

      - name: Create release branch on Github repository
        id: create-branch
        run: |
          git checkout ${{ env.DEFAULT_BRANCH }}
          git checkout -b ${{ ENV.STABLE_BRANCH }} && git push origin ${{ ENV.STABLE_BRANCH }} || git checkout ${{ ENV.STABLE_BRANCH }}
        shell: bash
        env:
          GITHUB_TOKEN: ${{ inputs.token }}

      - name: setup python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install required python modules
        run: pip3 install tox yq
        shell: bash

      - name: Prepare release
        run: tox -e prepare_release -vv
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.version }}

      - name: Update galaxy.yml file
        run: yq -yi ".version = \"$RELEASE_VERSION\"" galaxy.yml
        shell: bash
        env:
          RELEASE_VERSION: ${{ inputs.version }}

      - name: Create PR for changelog
        run: |
          git checkout -b ${{ env.RELEASE_BRANCH }}
          git config user.name "Ansible Bot"
          git config user.email devtools@ansible.com
          git add -A
          git commit -m "Release ${{ inputs.version }}"
          git push origin ${{ env.RELEASE_BRANCH }}
          gh pr create --title "Release ${{ inputs.version }}" --body "Automatic changes for Release ${{ inputs.version }}" --base ${{ env.STABLE_BRANCH }}
        env:
          GITHUB_TOKEN: ${{ inputs.token }}
